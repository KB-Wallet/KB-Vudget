<script setup>
import db from '@/../db.json'
import { ref, onMounted, computed, watch } from 'vue'
import dayjs from 'dayjs' // ü´†

onMounted(() => {
  console.log(db)
})

const userId = ref(1)
const selectedMonth = ref(dayjs()) // datepickerÏö© ÎÇ†Ïßú Í∞ùÏ≤¥ ÏÇ¨Ïö©
const currentFilter = ref('Ï†ÑÏ≤¥') // Ï†ÑÏ≤¥/ÏàòÏûÖ/ÏßÄÏ∂ú ÌïÑÌÑ∞ ÏÑ†ÌÉù ÏÉÅÌÉú
const currentPage = ref(1) // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ
const itemsPerPage = 5 // ÌéòÏù¥ÏßÄÎãπ listÎäî ÏµúÎåÄ 7Í∞ú

// ÏÑ†ÌÉùÎêú Ïõî Î¨∏ÏûêÏó¥ Î∞òÌôò (yyyy-MM)
const selectedMonthStr = computed(() => selectedMonth.value.format('YYYY-MM'))
// UI Ï∂úÎ†•Ïö© Ìè¨Îß∑: 2025ÎÖÑ 4Ïõî
const selectedMonthDisplay = computed(() => selectedMonth.value.format('YYYYÎÖÑ MÏõî'))

// Ï¢åÏö∞ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî Ïó¨Î∂Ä Í≥ÑÏÇ∞ (Ï≤´/ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄ Ï≤¥ÌÅ¨)
const isFirstPage = computed(() => currentPage.value === 1)
const totalPages = computed(() => Math.ceil(filteredHistory.value.length / itemsPerPage))
const isLastPage = computed(() => currentPage.value === totalPages.value)

// ÎÇ¥Ïó≠ ÏÑ†ÌÉù
const selectedRows = ref([])
const allChecked = computed({
  get: () =>
    selectedRows.value.length === paginatedHistory.value.length &&
    paginatedHistory.value.length > 0,
  set: (value) => {
    selectedRows.value = value ? paginatedHistory.value.map((item) => item.id) : []
  },
})

// ÏÑ†ÌÉù Ïõî ÎÇ¥Ïó≠ ÌïÑÌÑ∞ÎßÅ
const monthlyHistory = computed(() => {
  const incomeHistory = db.incomes
    .filter((i) => i.userId === userId.value && i.date.startsWith(selectedMonthStr.value))
    .map((i) => ({ type: 'ÏàòÏûÖ', ...i }))
  const expenseHistory = db.expenses
    .filter((e) => e.userId === userId.value && e.date.startsWith(selectedMonthStr.value))
    .map((e) => ({ type: 'ÏßÄÏ∂ú', ...e }))
  return [...incomeHistory, ...expenseHistory].sort((a, b) => new Date(a.date) - new Date(b.date))
})

// ÌïÑÌÑ∞ Ï†ÅÏö©Îêú ÎÇ¥Ïó≠ Í≥ÑÏÇ∞ (Ï†ÑÏ≤¥ / ÏàòÏûÖ / ÏßÄÏ∂ú)
const filteredHistory = computed(() => {
  if (currentFilter.value === 'Ï†ÑÏ≤¥') return monthlyHistory.value
  return monthlyHistory.value.filter((item) => item.type === currentFilter.value)
})

// ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏóê Î≥¥Ïó¨Ïßà Î¶¨Ïä§Ìä∏ Í≥ÑÏÇ∞
const paginatedHistory = computed(() => {
  const start = (currentPage.value - 1) * itemsPerPage
  const end = start + itemsPerPage
  return filteredHistory.value.slice(start, end)
})

// Ïõî Ïù¥Îèô Ìï®Ïàò (ÏôºÏ™Ω, Ïò§Î•∏Ï™Ω Î≤ÑÌäº)
const goPrevMonth = () => {
  selectedMonth.value = selectedMonth.value.subtract(1, 'month')
  currentPage.value = 1
}
const goNextMonth = () => {
  selectedMonth.value = selectedMonth.value.add(1, 'month')
  currentPage.value = 1
}

// ÌéòÏù¥ÏßÄ Ïù¥Îèô Ìï®Ïàò
const goPage = (num) => {
  currentPage.value = num
}

//
const toggleRow = (id) => {
  selectedRows.value = [id] // ‚úÖ Ìï≠ÏÉÅ Ìïú Ï§ÑÎßå ÏÑ†ÌÉùÎêòÎèÑÎ°ù Í≥†Ï†ï
}

watch(currentFilter, () => {
  selectedRows.value = [] // ‚úÖ ÌïÑÌÑ∞ Î≥ÄÍ≤Ω Ïãú ÏÑ†ÌÉù Ìï¥Ï†ú
})

// // Ìï¥Îãπ ÎÇ¥Ïó≠Ïùò ÎÇ†ÏßúÍ∞Ä ÏÑ†ÌÉùÎêú ÏõîÏóê ÏÜçÌïòÎäîÏßÄ ÌôïÏù∏ÌïòÎäî
// const isInMonth = (dateStr, monthStr) => {
//   return dateStr.startsWith(monthStr)
// }

// // ÏõîÎ≥Ñ ÎÇ¥Ïó≠ Í∞ÄÏ†∏Ïò§Í∏∞
// const monthlyHistory = computed(() => {
//   const incomeHistory = db.incomes
//     .filter((i) => i.userId === userId.value && isInMonth(i.date, selectedMonth.value))
//     .map((i) => ({
//       type: 'ÏàòÏûÖ',
//       ...i,
//     }))

//   const expenseHistory = db.expenses
//     .filter((e) => e.userId === userId.value && isInMonth(e.date, selectedMonth.value))
//     .map((e) => ({
//       type: 'ÏßÄÏ∂ú',
//       ...e,
//     }))

//   // ÎÇ†ÏßúÏàú Ï†ïÎ†¨
//   return [...incomeHistory, ...expenseHistory].sort((a, b) => new Date(a.date) - new Date(b.date))
// })
</script>

<template>
  <div class="historylist-container">
    <div class="historylist-title">
      <!-- Ïõî ÏÑ†ÌÉù Î∞è Ïù¥Îèô -->
      <div class="month-wrapper">
        <i
          class="fa-solid fa-chevron-left"
          :class="{ disabled: isFirstPage }"
          @click="goPrevMonth"
          style="cursor: pointer"
        ></i>
        <!-- ÏÇ¨Ïö©ÏûêÏóêÍ≤åÎäî 2025ÎÖÑ 4Ïõî ÌòïÌÉúÎ°ú Ï∂úÎ†•, Ïà®ÏùÄ Í∞íÏùÄ v-model Î∞îÏù∏Îî©Ïö© -->
        <span class="month-display">{{ selectedMonthDisplay }}</span>
        <input
          type="month"
          v-model="selectedMonthStr"
          style="opacity: 0; position: absolute; width: 0; height: 0"
        />
        <i
          class="fa-solid fa-chevron-right"
          :class="{ disabled: isLastPage }"
          @click="goNextMonth"
          style="cursor: pointer"
        ></i>
      </div>
      <!-- ÌïÑÌÑ∞ Î≤ÑÌäº Í∑∏Î£π -->
      <div class="btn-group filter-btn-group" role="group" aria-label="Filter">
        <button
          type="button"
          class="btn btn-outline-primary"
          :class="{ active: currentFilter === 'Ï†ÑÏ≤¥' }"
          @click="currentFilter = 'Ï†ÑÏ≤¥'"
        >
          Ï†ÑÏ≤¥
        </button>
        <button
          type="button"
          class="btn btn-outline-primary"
          :class="{ active: currentFilter === 'ÏàòÏûÖ' }"
          @click="currentFilter = 'ÏàòÏûÖ'"
        >
          ÏàòÏûÖ
        </button>
        <button
          type="button"
          class="btn btn-outline-primary"
          :class="{ active: currentFilter === 'ÏßÄÏ∂ú' }"
          @click="currentFilter = 'ÏßÄÏ∂ú'"
        >
          ÏßÄÏ∂ú
        </button>
      </div>

      <button type="button" class="btn addlist-btn">ÎÇ¥Ïó≠ Ï∂îÍ∞Ä</button>
    </div>

    <!-- Î¶¨Ïä§Ìä∏ ÌÖåÏù¥Î∏î -->
    <div class="historylist-table">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 30px"><input type="checkbox" v-model="allChecked" /></th>
            <th style="width: 80px">Î∂ÑÎ•ò</th>
            <th style="width: 130px">ÎÇ†Ïßú</th>
            <th style="width: 120px">Ïπ¥ÌÖåÍ≥†Î¶¨</th>
            <th style="width: 120px">Í≤∞Ï†úÏàòÎã®</th>
            <th style="width: 120px">Í±∞ÎûòÏ≤ò</th>
            <th style="width: 120px">Í∏àÏï°</th>
            <th style="width: 200px">Î©îÎ™®</th>
            <!-- <th style="width: 100px"></th> -->
          </tr>
        </thead>
        <tbody>
          <tr v-for="item in paginatedHistory" :key="item.id" @click="toggleRow(item.id)">
            <td>
              <input
                type="checkbox"
                :checked="selectedRows.includes(item.id)"
                @click.stop="toggleRow(item.id)"
              />
            </td>
            <td>
              <span :class="item.type === 'ÏàòÏûÖ' ? 'income-label' : 'expense-label'">{{
                item.type
              }}</span>
            </td>
            <td>{{ item.date }}</td>
            <td>{{ item.category }}</td>
            <td>{{ item.payment }}</td>
            <td>{{ item.vendor }}</td>
            <td>{{ item.amount.toLocaleString() }}Ïõê</td>
            <td>{{ item.description }}</td>
            <!-- <td>
              <i class="fa-solid fa-pencil edit-icon"></i>
              <i class="fa-solid fa-trash delete-icon"></i>
            </td> -->
          </tr>
          <!-- ÎÇ®ÏùÄ Îπà Ï§Ñ Î†åÎçîÎßÅ (ÏµúÎåÄ 10Ï§Ñ ÎßûÏ∂îÍ∏∞) -->
          <tr
            v-for="n in itemsPerPage - paginatedHistory.length"
            :key="'empty-' + n"
            class="empty-row"
          >
            <td colspan="5">&nbsp;</td>
          </tr>
        </tbody>
      </table>
      <!-- pagination -->
      <div class="pagination-container">
        <nav>
          <ul class="pagination">
            <li :class="['page-item', { disabled: isFirstPage }]">
              <a class="page-link" href="#" @click.prevent="!isFirstPage && goPage(currentPage - 1)"
                >&laquo;</a
              >
            </li>
            <li
              v-for="page in totalPages"
              :key="page"
              :class="['page-item', { active: currentPage === page }]"
            >
              <a class="page-link" href="#" @click.prevent="goPage(page)">{{ page }}</a>
            </li>
            <li :class="['page-item', { disabled: isLastPage }]">
              <a class="page-link" href="#" @click.prevent="!isLastPage && goPage(currentPage + 1)"
                >&raquo;</a
              >
            </li>
          </ul>
        </nav>
      </div>
      <div class="deletebtn-wrapper">
        <button type="button" class="btn selected-deletebtn">ÏÑ†ÌÉù ÎÇ¥Ïó≠ ÏÇ≠Ï†ú</button>
      </div>
    </div>
  </div>
</template>

<style scoped>
.historylist-container {
  display: flex;
  flex-direction: column;
  border: 1px solid lightgray;
  border-radius: 10px;
  padding: 20px 30px;
  min-width: 1200px;
}
.historylist-title {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 50px;
  margin-bottom: 1rem;
}
.month-wrapper {
  display: flex;
  align-items: center;
  gap: 15px;
}
.month-display {
  font-size: 1.5rem;
  font-weight: 600;
}
.hidden-month-input {
  opacity: 0;
  position: absolute;
  width: 0;
  height: 0;
}
.filter-btn-group .btn {
  min-width: 70px;
  padding: 6px 12px;
  width: 80px;
}
.btn-outline-primary {
  border: 1px solid #ffbc00 !important;
  color: black !important;
  background-color: white !important;
}
.btn-outline-primary:hover,
.btn-outline-primary.active {
  background-color: #ffbc00 !important;
  color: white !important;
  border-color: #ffbc00 !important;
}
.addlist-btn,
.selected-deletebtn {
  border: 1px solid #ffbc00;
  background-color: white;
}
.addlist-btn:hover,
.selected-deletebtn:hover {
  background-color: #ffbc00;
  color: white;
}
.addlist-btn,
.selected-deletebtn {
  margin-left: auto;
}
.historylist-table table {
  width: 100%;
  border-collapse: collapse;
}
.historylist-table th,
.historylist-table td {
  text-align: center;
  padding: 10px;
  white-space: nowrap;
  height: 48px;
}
.table-striped tbody tr {
  background-color: white !important;
}
.income-label {
  background-color: #e6f3ff;
  border: 1px solid #3399ff;
  padding: 2px 6px;
  border-radius: 4px;
  display: inline-block;
  font-weight: 600;
  line-height: 1.2;
}
.expense-label {
  background-color: #ffeaea;
  border: 1px solid #ff3d3d;
  padding: 2px 6px;
  border-radius: 4px;
  display: inline-block;
  font-weight: 600;
  line-height: 1.2;
}
.empty-row td {
  border: none;
  background: none;
  height: 48px;
}
.edit-icon {
  margin-right: 10px;
  cursor: pointer;
}
.delete-icon {
  cursor: pointer;
}
.pagination-container {
  display: flex;
  justify-content: center;
  margin-top: 10px;
}
.page-link {
  color: #545045;
  border: none;
  outline: none !important;
  box-shadow: none !important;
}
.page-item.active .page-link {
  font-weight: bold;
  color: black;
  background-color: transparent;
}
.page-link:focus,
.page-link:hover {
  background: none;
  border: none;
  outline: none !important;
  box-shadow: none !important;
}
.page-item.disabled .page-link {
  opacity: 0.4;
  pointer-events: none;
  background: none;
}
.deletebtn-wrapper {
  display: flex;

  justify-content: flex-end;
}
</style>

<!-- <style scoped>
.historylist-container {
  display: flex;
  flex-direction: column;
  border: 1px solid lightgray;
  border-radius: 10px;
  padding: 20px 30px;
  min-width: 1200px;
}
.historylist-title {
  display: flex;
  flex-direction: row;
  margin-bottom: 1rem;
  align-items: center;
  gap: 50px;
}
.month-wrapper {
  display: flex;
  align-items: center;
  gap: 15px;
}
.month-display {
  font-size: 1.5rem;
  font-weight: 600;
}
.filter-btn-group .btn {
  min-width: 70px;
  padding: 6px 12px;
  width: 80px;
}
.btn-outline-primary {
  border: 1px solid #ffbc00 !important;
  color: black !important;
  background-color: white !important;
}
.btn-outline-primary:hover,
.btn-outline-primary.active {
  background-color: #ffbc00 !important;
  color: white !important;
  border-color: #ffbc00 !important;
}
.addlist-btn,
.selected-deletebtn {
  border: 1px solid #ffbc00;
  background-color: white;
}
.addlist-btn:hover,
.selected-deletebtn:hover {
  background-color: #ffbc00;
  color: white;
}
.addlist-btn,
.selected-deletebtn {
  margin-left: auto;
}
.historylist-table {
  min-width: 900px;
}
/* üìå ÌÖåÏù¥Î∏î Ïó¥ ÎÑàÎπÑ Í≥†Ï†ï */
.table thead th,
.table tbody td {
  width: 120px;
  white-space: nowrap;
  text-align: center;
}
/* üìå Î¶¨Ïä§Ìä∏ Ìñâ Î∞∞Í≤ΩÏÉâ Í≥†Ï†ï (Ìù∞ÏÉâ) */
.table-striped tbody tr {
  background-color: white !important;
}
/* üìå ÏàòÏûÖ Ìï≠Î™© Ïä§ÌÉÄÏùº */
tr td:first-child:has(+ td:contains('ÏàòÏûÖ')) ~ td {
  background-color: #e6f3ff;
  border: 1px solid #3399ff;
}
/* üìå ÏßÄÏ∂ú Ìï≠Î™© Ïä§ÌÉÄÏùº */
tr td:first-child:has(+ td:contains('ÏßÄÏ∂ú')) ~ td {
  background-color: #ffeaea;
  border: 1px solid #ff3d3d;
}
/* üìå Î¶¨Ïä§Ìä∏ Ìñâ ÎÜíÏù¥ Í≥†Ï†ï (10Í∞ú Ïú†ÏßÄÏö©) */
tbody {
  min-height: 500px;
  display: block;
}
tbody tr {
  display: table;
  width: 100%;
  table-layout: fixed;
  height: 50px;
}
tbody:after {
  content: '';
  display: block;
  height: calc(10 * 50px - var(--actual-row-height));
}
.edit-icon {
  margin-right: 10px;
  cursor: pointer;
}
.delete-icon {
  cursor: pointer;
}
.pagination-container {
  display: flex;
  justify-content: center;
}
.page-link {
  color: #545045;
  border: none;
}
.page-item.active .page-link {
  font-weight: bold;
  font-size: 1.2rem;
  color: black;
  background-color: transparent;
}
.page-link:focus,
.page-link:hover {
  color: #000;
  background: none;
  border: none;
}
.page-item.disabled .page-link {
  opacity: 0.4;
  pointer-events: none;
}
.deletebtn-wrapper {
  display: flex;
}
</style> -->

<!-- <style scoped>
.historylist-container {
  display: flex;
  flex-direction: column;
  border: 1px solid lightgray;
  border-radius: 10px;
  padding: 20px 30px;
  min-width: 1200px;
}
.historylist-title {
  display: flex;
  flex-direction: row;
  margin-bottom: 1rem;
  /* justify-content: space-between; */
  align-items: center;
  gap: 50px;
}
.historylist-table {
  min-width: 900px;
}
.month-wrapper {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  gap: 25px;
  flex: 1;
  min-width: 180px;
}
.month-display {
  font-size: 1.5rem;
  font-weight: 600;
  margin: 0 10px;
}
/* .month-wrapper > i {
  width: 1.5rem;
} */
.option-btncontainer {
  display: flex;
  flex: 5;
  gap: 20px;
}
.option-btncontainer > button,
.addlist-btn,
.selected-deletebtn {
  border: 1px solid #ffbc00;
  background-color: white;
}
.option-btncontainer > button:hover,
.addlist-btn:hover,
.selected-deletebtn:hover {
  background-color: #ffbc00;
  color: white;
}
.option-btncontainer > button:focus,
.addlist-btn:focus,
.selected-deletebtn:focus {
  border: none;
}
.deletebtn-wrapper {
  display: flex;
}
.selected-deletebtn {
  margin-left: auto;
}
.pagination-container {
  display: flex;
  justify-content: center;
}
.page-link {
  color: #545045;
  border: none;
}
/* Ïù¥Í±∞ active (ÌòÑÏû¨ ÌéòÏù¥ÏßÄ ÎîîÏûêÏù∏ Î∞îÍæ∏Í∏∞) */
.page-item.active .page-link {
  z-index: 1;
  color: black;
  font-size: 1.2rem;
  font-weight: bold;
  background-color: none;
}
.page-link:focus,
.page-link:hover {
  color: #000;
  background: none;
  border: none;
}
.page-item.disabled .page-link {
  opacity: 0.4;
  pointer-events: none;
}
</style> -->

<!-- pagination, Í≤ÄÏÉâ -->
